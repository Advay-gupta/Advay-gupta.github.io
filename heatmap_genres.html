<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heatmap from CSV Data</title>
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-heatmap.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .tooltip {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      border-radius: 5px;
      pointer-events: none; /* Ensure the tooltip does not block mouse events */
      transition: opacity 0.3s ease-in-out;
      z-index: 999; /* Ensure it's above other elements */
    }

    .tooltipPerm {
      position: absolute;
      font-size: 30px;
      top: 1%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding-left: 50px;
      padding-right: 50px;
      border-radius: 5px;
      pointer-events: none; /* Ensure the tooltip does not block mouse events */
      transition: opacity 0.3s ease-in-out;
      z-index: -1; /* Ensure it's above other elements */
    }

    #container {
      height: 900px;
      width: 100%;
      padding-top: : 2%;
    }
  </style>
</head>
<body>
  <!-- create the sliders for changing month and year of the displayed data -->
  <div>
    <label for="yearSlider">Year:</label>
    <input type="range" min="2017" max="2020" value="2017" class="slider" id="yearSlider" disabled>
    <span id="yearValue"></span>
  </div>
  <div>
    <label for="monthSlider">Month:</label>
    <input type="range" min="1" max="12" value="1" class="slider" id="monthSlider" disabled>
    <span id="monthValue"></span>
  </div>
  <!-- this tooltip houses the permanent tooltip showing currently selected month and year -->
    <div class="tooltipPerm" id="yearMonthTooltip"></div>
    <div id="container"></div>
  <script>
  // variable to hold the database's loaded data
    var data;
    var monthList = [
    'Filler', 'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
    ];

// function to plot the heatmap
    anychart.onDocumentReady(function () {
      var container = document.getElementById('container');
      var yearSlider = document.getElementById("yearSlider");
      var monthSlider = document.getElementById("monthSlider");
      var prevMonthButton = document.getElementById("prevMonth");
      var nextMonthButton = document.getElementById("nextMonth");
      var yearOutput = document.getElementById("yearValue");
      var monthOutput = document.getElementById("monthValue");
      var tooltipPerm = document.getElementById("yearMonthTooltip");

      // Initial heatmap
      d3.csv("FinalDatabase_updated.csv").then(function(csvData) {
        data = csvData; // Store the loaded CSV data in the variable
        updateHeatmap(yearSlider.value, monthSlider.value, data);
      });

      // Update year and month values
      updateYearMonth();

// redraw map on changing month or year value
      yearSlider.oninput = function () {
        yearOutput.innerHTML = this.value;
        updateHeatmap(this.value, monthSlider.value, data);
        updateYearMonth();
      }

      monthSlider.oninput = function () {
        monthOutput.innerHTML = this.value;
        updateHeatmap(yearSlider.value, this.value, data);
        updateYearMonth();
      }

      // Function to update the year and month tooltip
      function updateYearMonth() {
        var year = yearSlider.value;
        var month = monthSlider.value;
        tooltipPerm.innerHTML = "<strong>" + monthList[parseInt(month)] + "</strong> " + year; // Update tooltip content
      }

// function to change the month and year on press of the arrow keys
      document.addEventListener("keydown", function(event) {
        var key = event.key;
        if (key === "ArrowLeft") {
          if (parseInt(monthSlider.value) > 1) {
            monthSlider.value = parseInt(monthSlider.value) - 1;
          } else {
            if (parseInt(yearSlider.value) > 2017) {
              yearSlider.value = parseInt(yearSlider.value) - 1;
              monthSlider.value = 12;
            }
          }
          updateHeatmap(yearSlider.value, monthSlider.value, data);
          updateYearMonth();
        } else if (key === "ArrowRight") {
          if (parseInt(monthSlider.value) < parseInt(monthSlider.max)) {
            monthSlider.value = parseInt(monthSlider.value) + 1;
          } else {
            if (parseInt(yearSlider.value) < 2020) {
              yearSlider.value = parseInt(yearSlider.value) + 1;
              monthSlider.value = 1;
            }
          }
          updateHeatmap(yearSlider.value, monthSlider.value, data);
          updateYearMonth();
        }
      });

      function updateHeatmap(year, month, data) {
        // Filter data based on selected year and month
        var filteredData = data.filter(function(d) {
          var modifiedMonth = month.length === 1 ? '0' + month : month;
          return d.Release_date.includes(year + "-" + modifiedMonth);
        });

        // Get unique countries and genres
        var countries = [...new Set(filteredData.map(d => d.Country))];

        // the most popular genres in the database (for relevance) (involved in >1000 rows in the database)
        var genres = [
          'dance pop',
          'latin',
          'pop',
          'k-pop',
          'n-a',
          'german hip hop',
          'atl hip hop',
          'francoton',
          'dutch hip hop',
          'big room',
          'hip hop',
          'canadian hip hop',
          'emo rap',
          'french hip hop',
          'finnish dance pop',
          'melodic rap',
          'boy band',
          'italian hip hop',
          'alternative metal',
          'canadian pop',
          'modern rock',
          'chicago rap',
          'deep german hip hop',
          'colombian pop',
          'conscious hip hop',
          'adult standards',
          'detroit hip hop',
          'alternative r&b',
          'electropop',
          'canadian contemporary r&b',
          'edm',
          'art pop',
          'polish hip hop',
          'dfw rap',
          'mandopop',
          'danish hip hop',
          'rap'
        ]

        // Calculate percentage of each genre's songs for each country
        var heatmapData = [];
        countries.forEach(function(country) {
          var countryData = {};
          countryData['name'] = country;
          genres.forEach(function(genre) {
            var genreSongs = filteredData.filter(function(d) {
              return d.Country === country && d.Genre === genre
            }).length;

            var totalSongs = filteredData.filter(function(d) {
              return d.Country === country;
            }).length;

            var percentage = totalSongs > 0 ? (genreSongs / totalSongs) * 100 : 0;
            countryData[genre] = percentage;
            countryData[genre + 'filtered'] = genreSongs;
            countryData[genre + 'total'] = totalSongs;
          });
          heatmapData.push(countryData);
        });

        // Convert data to format suitable for AnyChart heatmap
        var anychartData = [];
        heatmapData.forEach(function(countryData) {
          genres.forEach(function(genre) {
            var newdic = {};
            newdic['x'] = genre;
            newdic['y'] = countryData["name"];
            newdic['heat'] = countryData[genre];
            newdic['filtered'] = countryData[genre + 'filtered'];
            newdic['total'] = countryData[genre + 'total'];
            anychartData.push(newdic);
          });
        });

        container.innerHTML = '';

        // Create AnyChart heatmap
        var chart = anychart.heatMap(anychartData);
        chart.title("Heatmap of Genre Distribution by Country");
        chart.container(container);

        // Define the color scale for the heatmap
        var colorScale = anychart.scales.linearColor();
        colorScale.colors(["black", "#010101", "#020202", "#030303", "#040404", "#050505", "#060606", "#070707", "#080808", "#090909", "#0A0A0A", "#0B0B0B", "#0C0C0C", "#0D0D0D", "#0E0E0E", "#0F0F0F", "#101010", "#111111",
        "#121212", "#131313", "#141414", "#151515", "#161616", "#171717", "#181818", "#191919", "#1A1A1A", "#1B1B1B", "#1C1C1C", "#1D1D1D", "#1E1E1E", "#1F1F1F", "#202020", "#212121", "#222222", "#232323", "#242424",
        "#252525", "#262626", "#272727", "#282828", "#292929", "#2A2A2A", "#2B2B2B", "#2C2C2C", "#2D2D2D", "#2E2E2E", "#2F2F2F", "#303030", "#313131", "#323232", "#333333", "#343434", "#353535", "#363636", "#373737",
        "#383838", "#393939", "#3A3A3A", "#3B3B3B", "#3C3C3C", "#3D3D3D", "#3E3E3E", "#3F3F3F", "#404040", "#414141", "#424242", "#434343", "#444444", "#454545", "#464646", "#474747", "#484848", "#494949", "#4A4A4A",
        "#4B4B4B", "#4C4C4C", "#4D4D4D", "#4E4E4E", "#4F4F4F", "#505050", "#515151", "#525252", "#535353", "#545454", "#555555", "#565656", "#575757", "#585858", "#595959", "#5A5A5A", "#5B5B5B", "#5C5C5C", "#5D5D5D",
        "#5E5E5E", "#5F5F5F", "#606060", "#616161", "#626262", "#636363", "#646464", "#656565", "#666666", "#676767", "#686868", "#696969", "#6A6A6A", "#6B6B6B", "#6C6C6C", "#6D6D6D", "#6E6E6E", "#6F6F6F", "#707070",
        "#717171", "#727272", "#737373", "#747474", "#757575", "#767676", "#777777", "#787878", "#797979", "#7A7A7A", "#7B7B7B", "#7C7C7C", "#7D7D7D", "#7E7E7E", "#7F7F7F", "#808080", "#818181", "#828282", "#838383",
        "#848484", "#858585", "#868686", "#878787", "#888888", "#898989", "#8A8A8A", "#8B8B8B", "#8C8C8C", "#8D8D8D", "#8E8E8E", "#8F8F8F", "#909090", "#919191", "#929292", "#939393", "#949494", "#959595", "#969696",
        "#979797", "#989898", "#999999", "#9A9A9A", "#9B9B9B", "#9C9C9C", "#9D9D9D", "#9E9E9E", "#9F9F9F", "#A0A0A0", "#A1A1A1", "#A2A2A2", "#A3A3A3", "#A4A4A4", "#A5A5A5", "#A6A6A6", "#A7A7A7", "#A8A8A8", "#A9A9A9",
        "#AAAAAA", "#ABABAB", "#ACACAC", "#ADADAD", "#AEAEAE", "#AFAFAF", "#B0B0B0", "#B1B1B1", "#B2B2B2", "#B3B3B3", "#B4B4B4", "#B5B5B5", "#B6B6B6", "#B7B7B7", "#B8B8B8", "#B9B9B9", "#BABABA", "#BBBBBB", "#BCBCBC",
        "#BDBDBD", "#BEBEBE", "#BFBFBF", "#C0C0C0", "#C1C1C1", "#C2C2C2", "#C3C3C3", "#C4C4C4", "#C5C5C5", "#C6C6C6", "#C7C7C7", "#C8C8C8", "#C9C9C9", "#CACACA", "#CBCBCB", "#CCCCCC", "#CDCDCD", "#CECECE", "#CFCFCF",
        "#D0D0D0", "#D1D1D1", "#D2D2D2", "#D3D3D3", "#D4D4D4", "#D5D5D5", "#D6D6D6", "#D7D7D7", "#D8D8D8", "#D9D9D9", "#DADADA", "#DBDBDB", "#DCDCDC", "#DDDDDD", "#DEDEDE", "#DFDFDF", "#E0E0E0", "#E1E1E1", "#E2E2E2",
        "#E3E3E3", "#E4E4E4", "#E5E5E5", "#E6E6E6", "#E7E7E7", "#E8E8E8", "#E9E9E9", "#EAEAEA", "#EBEBEB", "#ECECEC", "#EDEDED", "#EEEEEE", "#EFEFEF", "#F0F0F0", "#F1F1F1", "#F2F2F2", "#F3F3F3", "#F4F4F4", "#F5F5F5",
        "#F6F6F6", "#F7F7F7", "#F8F8F8", "#F9F9F9", "#FAFAFA", "#FBFBFB", "#FCFCFC", "#FDFDFD", "#FEFEFE", "yellow"]); // Black for 0% participation, yellow for others

        // DEFINE THE TOOLTIP FORMAT FOR THE HEATMAP
        chart.tooltip().titleFormat(function () {
          return 'Value: ' + this.getData('heat').toFixed(2) + '%' + ' (' + this.getData('filtered') + '/' + this.getData('total') + ' are Explicit' + ')';
        });
        chart.tooltip().format(function () {
          return 'Country: ' + this.getData('y') + ', Genre: ' + this.getData('x');
        });

        // Set x-axis labels (genres) and y-axis labels (countries)
        chart.xAxis().staggerMode(true).staggerLines(2); // Stagger mode to fit more labels
        chart.xAxis().labels().format(function() {
          return genres[this.index];
        }).padding(5);
        chart.yAxis().labels().format(function() {
          return countries[this.index];
        }).padding(5);

        chart.draw();

      };

    });
  </script>
</body>
</html>
