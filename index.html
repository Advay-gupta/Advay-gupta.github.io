<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<!-- Add year and month sliders -->
<div>
  <label for="yearSlider">Year:</label>
  <input type="range" min="2017" max="2023" value="2017" class="slider" id="yearSlider">
  <span id="yearValue">2017</span>
</div>
<div>
  <label for="monthSlider">Month:</label>
  <input type="range" min="1" max="12" value="1" class="slider" id="monthSlider">
  <span id="monthValue">1</span>
</div>

<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="800" height="600"></svg>

<script>
  // The svg
  var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

  // Map and projection
  var path = d3.geoPath();
  var projection = d3.geoMercator()
    .scale(150)
    .center([0,20])
    .translate([width / 2, height / 2]);

  // Color scale
  var colorScale = d3.scaleThreshold()
    .domain([10, 20, 30, 40, 50, 60, 70, 80, 90])
    .range(d3.schemeBlues[9]);

  // Load external data and boot
  d3.queue()
    .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
    .defer(d3.csv, "FinalDatabase_updated.csv?v=1") // Load CSV data with unique query parameter
    .await(ready);

  function ready(error, topo, data) {
    var yearSlider = document.getElementById("yearSlider");
    var monthSlider = document.getElementById("monthSlider");

    // Display the default slider value
    var yearOutput = document.getElementById("yearValue");
    var monthOutput = document.getElementById("monthValue");

    yearOutput.innerHTML = yearSlider.value;
    monthOutput.innerHTML = monthSlider.value;

    // Draw the initial map
    drawMap(topo, data, yearSlider.value, monthSlider.value);

    yearSlider.oninput = function() {
      yearOutput.innerHTML = this.value;
      var selectedYear = this.value;
      console.log(selectedYear);
      if (selectedYear == "2023") {
        monthSlider.max = "5"; // Limit month slider range
        if (monthSlider.value == "1" || monthSlider.value == "2" || monthSlider.value == "3" || monthSlider.value == "4" || monthSlider.value == "5"){
          monthOutput.innerHTML = monthSlider.value;
        }
        else{
          monthOutput.innerHTML = "5";
          monthSlider.value = "5";
        }
      } else {
        monthSlider.max = "12"; // Reset month slider range
      }
      redrawMap(topo, data, this.value, monthSlider.value); // Redraw map when year changes
    }

    monthSlider.oninput = function() {
      monthOutput.innerHTML = this.value;
      var selectedMonth = this.value.length === 1 ? '0' + this.value : this.value;
      console.log(selectedMonth);
      redrawMap(topo, data, yearSlider.value, selectedMonth); // Redraw map when month changes
    }

    function drawMap(topo, data, year, month) {
        console.log(year + "-" + (month.length === 1 ? '0' + month : month));
        var filteredData = data.filter(function(d) {
            var modifiedMonthString = month.length === 1 ? '0' + month : month;
            return d.Release_date.includes(year + "-" + modifiedMonthString);
        });

        // Store all unique values of the 'Country' column in filteredData
        var uniqueCountries = [...new Set(filteredData.map(d => d.Country))];

        // Calculate the explicit percentage for each country
        var countryExplicitPercentages = {};
        uniqueCountries.forEach(function(country) {
            var countryTotalData = filteredData.filter(function(d) {
                return d.Country === country;
            });
            var countryExplicitData = countryTotalData.filter(function(d) {
                return d.Explicit === 'True';
            });
            var percentageExplicit = countryTotalData.length > 0 ? (countryExplicitData.length * 100 / countryTotalData.length) : 0;
            countryExplicitPercentages[country] = percentageExplicit;
        });

        // Draw the map
        svg.selectAll("path")
            .data(topo.features)
            .enter()
            .append("path")
            .attr("d", d3.geoPath().projection(projection))
            .attr("fill", function(d) {
                var countryName = d.properties.name;
                var percentage = countryExplicitPercentages[countryName] || 0;
                console.log(countryName + ": " + percentage + "%");
                return colorScale(percentage);
            })
            .style("stroke", "transparent");
    }


    function redrawMap(topo, data, year, month) {
      svg.selectAll("path").remove(); // Remove existing paths
      drawMap(topo, data, year, month); // Draw map with new data
    }
  }

</script>
